<!--
  Copyright 2016 The LUCI Authors. All rights reserved.
  Use of this source code is governed under the Apache License, Version 2.0
  that can be found in the LICENSE file.

  This in an HTML Import-able file that contains the definition
  of the following elements:

    <bot-list-data>

  This makes calls authenticated with Oauth 2 to the swarming apis.  It parses
  that data into usable data structures.

  Usage:

    <bot-list-data></bot-list-data>

  Properties:
    // inputs
    auth_headers: Object, the OAuth2 header to include in the request.  This
        should come from swarming-app.
    query_params: Object, The query params that will filter the query
        server-side.  This can have dimensions:Array<String>, quarantined:String
        and is_dead: String. For example:
        {
          "dimensions": ["pool:Skia", "device_type:sprout"],
          "quarantined": "FALSE",  // optional
          "is_dead": "TRUE",       // optional
        }
        For a full list of dimensions in the fleet, see the API call:
        https://[swarming_url]/_ah/api/swarming/v1/bots/dimensions
    // outputs
    tasks: Array<Object>, all tasks returned by the server.

  Methods:
    signIn(): Force a signin of the user using OAuth.  This happens
        automatically when auth_headers is set.

  Events:
    None.
-->

<link rel="import" href="/res/imp/common/common-behavior.html">

<dom-module id="task-list-data">
  <script>
  (function(){
    Polymer({
      is: 'task-list-data',

      behaviors: [
          SwarmingBehaviors.CommonBehavior,
      ],

      properties: {
        // inputs
        auth_headers: {
          type: Object,
          observer: "signIn",
        },
        query_params: {
          type: Object,
          observer: "_request",
        },

        // outputs
        busy: {
          type: Boolean,
          computed: "_or(_busy1,_busy2,_busy3)",
          notify: true,
        },
        primary_map: {
          type: Object,
          computed: "_primaryMap(_tags,_dimensions,tasks)",
          notify: true,
        },
        primary_arr: {
          type: Array,
          computed: "_primaryArr(primary_map)",
          notify: true,
        },
        tasks: {
          type: Array,
          computed: "_tasks(_list)",
          notify: true,
        },

        // private
         _busy1: {
          type: Boolean,
          value: false
        },
        _busy2: {
          type: Boolean,
          value: false
        },
        _busy3: {
          type: Boolean,
          value: false
        },
        _dimensions: {
          type: Object,
        },
        _list: {
          type: Object,
        },
        _tags: {
          type: Object,
        },
      },

      signIn: function(){
        this._getJsonAsync("_tags", "/_ah/api/swarming/v1/tasks/tags",
          "_busy2", this.auth_headers);
        this._getJsonAsync("_dimensions","/_ah/api/swarming/v1/bots/dimensions",
          "_busy3", this.auth_headers);

        this._request();
      },

      _primaryArr: function(map) {
        var arr = Object.keys(map);
        arr.sort();
        return arr;
      },

      _primaryMap: function(tags, dims, tasks) {
        tags = (tags && tags.tasks_tags) || [];
        dims = (dims && dims.bots_dimensions) || [];
        tasks = tasks || [];
        var map = {};
        // We combine all the tags reported by the tags endpoint, all known
        // dimensions from the dimensions endpoint, and the tags seen in the
        // returned tasks, just in case they didn't show up in the first two.
        // This way a user can filter by what the data actually has and can
        // discover new tags to filter by.
        tags.forEach(function(t) {
          if (!map[t.key]) {
            map[t.key] = {};
          }
          var values = t.value || [];
          values.forEach(function(v) {
            map[t.key][v] = true;
          })
        });

        dims.forEach(function(d) {
          var vals = d.value;
          if (!map[d.key]) {
            map[d.key] = {};
          }
          vals.forEach(function(v) {
            map[d.key][v] = true;
          })
        });

        tasks.forEach(function(t) {
          Object.keys(t.tagMap).forEach(function(k) {
            var v = t.tagMap[k];
            if (!map[k]) {
              map[k] = {};
            }
            map[k][v] = true;
          });
        });

        // Turn the Map<Object,Map<Boolean>> into a Map<Object,Array<String>>
        // with all of the aliases applied.
        var pMap = {};
        for (key in map) {
          var values = Object.keys(map[key]);
          if (swarming.alias.DIMENSIONS_WITH_ALIASES.indexOf(key) === -1) {
            pMap[key] = values;
          } else if (key === "gpu") {
            var gpus = [];
            values.forEach(function(g){
              var alias = swarming.alias.gpu(g);
              if (alias !== "unknown") {
                gpus.push(swarming.alias.apply(g, alias));
              } else {
                gpus.push(g);
              }
            }.bind(this));
            pMap["gpu"] = gpus;
          } else if (key === "device_type") {
            var devs = [];
            values.forEach(function(dt){
              var alias = swarming.alias.android(dt);
              if (alias !== "unknown") {
                devs.push(swarming.alias.apply(dt, alias));
              } else {
                devs.push(dt);
              }
            }.bind(this));
            pMap["device_type"] = devs;
          } else {
            console.log("Unknown alias type: ", d);
          }
        }

        // Add some options that might not show up.
        pMap["android_devices"].push("0");
        pMap["device_os"].push("none");
        pMap["device_type"].push("none");
        pMap["user"].push("none");

        // Custom filter options
        pMap["name"] = [];
        pMap["state"] = ["PENDING", "RUNNING", "PENDING_RUNNING", "COMPLETED",
            "COMPLETED_SUCCESS","COMPLETED_FAILURE", "EXPIRED", "TIMED_OUT",
            "BOT_DIED", "CANCELED", "ALL", "DEDUPED"];
        pMap["abandoned_ts"] = [];
        pMap["completed_ts"] = [];
        pMap["costs_usd"] = [];
        pMap["created_ts"] = [];
        pMap["deduped_from"] = [];
        pMap["duration"] = [];
        pMap["modified_ts"] = [];
        pMap["server_versions"] = [];
        pMap["started_ts"] = [];

        return pMap;
      },

      _request: function() {
        // wait until the user has logged in and the filters have loaded before requesting this to avoid double or even triple requests.
        if (!this.auth_headers || !this.query_params) {
          return;
        }
        this._getJsonAsync("_list", "/_ah/api/swarming/v1/tasks/list",
          "_busy1", this.auth_headers, this.query_params);
      },

      _tasks: function() {
        if (!this._list || !this._list.items) {
          return [];
        }
        // Do any preprocessing here
        this._list.items.forEach(function(t) {
          var tagMap = {};
          t.tags.forEach(function(tag) {
            var split = tag.split(":", 1)
            var key = split[0];
            var rest = tag.substring(key.length + 1);
            tagMap[key] = rest;
          });
          t.tagMap = tagMap;
        });
        return this._list.items;
      }
    });
  })();
  </script>
</dom-module>
